<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaboration Space | f: H √ó A ‚Üí ùíú</title>
    <meta name="description" content="3D visualization of human-AI collaboration. The function f: Human √ó AI ‚Üí Artifact, explored in space.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Collaboration Space | f: Human √ó AI ‚Üí Artifact">
    <meta property="og:description" content="3D visualization of human-AI collaboration. Drag to rotate, scroll to zoom, click artifacts.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://selfexecuting.art/collaboration_space.html">
    <meta property="og:image" content="https://selfexecuting.art/og-image.png">
    <meta name="twitter:card" content="summary_large_image">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: #0a0a0f;
            color: #e8e8f0;
            overflow: hidden;
        }
        
        #canvas-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
        }
        
        .overlay {
            position: fixed;
            z-index: 100;
            pointer-events: none;
        }
        
        .header {
            top: 2rem;
            left: 2rem;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 400;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        
        .header .subtitle {
            color: #888899;
            font-size: 0.85rem;
        }
        
        .legend {
            bottom: 6rem;
            left: 2rem;
            background: rgba(10, 10, 15, 0.9);
            border: 1px solid #2a2a3a;
            border-radius: 8px;
            padding: 1.5rem;
            pointer-events: auto;
        }
        
        .legend h3 {
            font-size: 0.8rem;
            font-weight: 500;
            color: #6699ff;
            margin-bottom: 1rem;
            letter-spacing: 0.05em;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.6rem;
            font-size: 0.75rem;
            color: #888899;
        }
        
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .legend-line {
            width: 20px;
            height: 2px;
        }
        
        .controls {
            bottom: 6rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: auto;
        }
        
        .controls button {
            background: rgba(10, 10, 15, 0.9);
            border: 1px solid #2a2a3a;
            border-radius: 6px;
            color: #e8e8f0;
            font-family: inherit;
            font-size: 0.75rem;
            padding: 0.6rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .controls button:hover {
            border-color: #6699ff;
            color: #6699ff;
        }
        
        .controls button.active {
            background: #6699ff;
            color: #0a0a0f;
            border-color: #6699ff;
        }
        
        .info-panel {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 100;
            background: rgba(10, 10, 15, 0.95);
            border: 1px solid #2a2a3a;
            border-radius: 8px;
            padding: 1.5rem;
            max-width: 300px;
            display: none;
            pointer-events: auto;
        }
        
        .info-panel.visible { display: block; }
        
        .info-panel h3 {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }
        
        .info-panel p {
            font-size: 0.75rem;
            color: #888899;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }
        
        .info-panel .fiber-count {
            color: #66ff99;
            font-size: 1.2rem;
            margin: 0.5rem 0;
        }
        
        .info-panel .close {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            color: #888899;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .info-panel .play-sound {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid #66ff99;
            color: #66ff99;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        
        .info-panel .play-sound:hover {
            background: #66ff99;
            color: #0a0a0f;
        }
        
        .back-link {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 100;
            color: #888899;
            text-decoration: none;
            font-size: 0.8rem;
        }
        
        .back-link:hover { color: #6699ff; }
        
        /* Timeline slider */
        .timeline {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            max-width: 600px;
            z-index: 100;
            pointer-events: auto;
        }
        
        .timeline-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #555566;
            margin-bottom: 0.5rem;
        }
        
        .timeline input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            background: transparent;
        }
        
        .timeline input[type="range"]::-webkit-slider-track {
            height: 4px;
            background: #2a2a3a;
            border-radius: 2px;
        }
        
        .timeline input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #ffcc66;
            border-radius: 50%;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 10px rgba(255, 204, 102, 0.5);
        }
        
        .timeline-moment {
            text-align: center;
            font-size: 0.75rem;
            color: #ffcc66;
            margin-top: 0.5rem;
            min-height: 1.5em;
            font-style: italic;
        }
        
        .instructions {
            position: fixed;
            top: 5rem;
            left: 2rem;
            font-size: 0.65rem;
            color: #444455;
            z-index: 50;
        }
        
        /* Intro Modal */
        .intro-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.95);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        .intro-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .intro-content {
            max-width: 500px;
            padding: 2rem;
            text-align: center;
        }
        .intro-content h2 {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            font-size: 1.8rem;
            color: #e8e8f0;
            margin-bottom: 1.5rem;
        }
        .intro-content p {
            color: #aaa;
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .intro-content ul {
            list-style: none;
            padding: 0;
            margin: 1.5rem 0;
            text-align: left;
        }
        .intro-content li {
            color: #888;
            margin: 0.5rem 0;
            padding-left: 1rem;
        }
        .intro-content .human-dot { color: #ff6699; }
        .intro-content .ai-dot { color: #6699ff; }
        .intro-content .artifact-dot { color: #66ff99; }
        .intro-hint {
            font-size: 0.85rem;
            color: #666;
            margin-top: 1.5rem;
        }
        #intro-dismiss {
            margin-top: 1.5rem;
            padding: 0.75rem 2rem;
            background: transparent;
            border: 1px solid #66ff99;
            color: #66ff99;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        #intro-dismiss:hover {
            background: #66ff99;
            color: #0a0a0f;
        }
        .intro-remember {
            display: block;
            margin-top: 1rem;
            font-size: 0.75rem;
            color: #555;
            cursor: pointer;
        }
        .intro-remember input {
            margin-right: 0.5rem;
        }
        
        /* Mapping sliders */
        .mapping-sliders {
            position: fixed;
            bottom: 6rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(10, 10, 15, 0.95);
            border: 1px solid #2a2a3a;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            display: flex;
            flex-wrap: nowrap;
            gap: 1.5rem;
            pointer-events: auto;
            max-width: 95vw;
            overflow-x: scroll;
            scrollbar-width: thin;
            scrollbar-color: #444 #1a1a2a;
        }
        
        .mapping-sliders::-webkit-scrollbar {
            height: 8px;
        }
        .mapping-sliders::-webkit-scrollbar-track {
            background: #1a1a2a;
            border-radius: 4px;
        }
        .mapping-sliders::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        
        .slider-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
            min-width: 70px;
        }
        
        .slider-group label {
            font-size: 0.75rem;
            color: #888899;
            font-family: 'Times New Roman', serif;
            font-style: italic;
        }
        
        .slider-group label.human { color: #ff6699; }
        .slider-group label.ai { color: #6699ff; }
        .slider-group label.artifact { color: #66ff99; }
        .slider-group label.fiber { color: #ffcc66; }
        .slider-group label.entropy { color: #cc99ff; }
        .slider-group label.surjective { color: #99ffcc; }
        .slider-group label.decay { color: #ff9966; }
        .slider-group label.converge { color: #66ccff; }
        .slider-group label.kernel { color: #ff6666; }
        .slider-group label.derivative { color: #ffff66; }
        .slider-group label.injective { color: #66ffff; }
        .slider-group label.probability { color: #ff66ff; }
        
        .toggle-btn {
            background: transparent;
            border: 1px solid #444;
            color: #888;
            padding: 0.3rem 0.5rem;
            font-size: 0.65rem;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Times New Roman', serif;
            font-style: italic;
        }
        .toggle-btn.active {
            background: rgba(102, 255, 255, 0.2);
            border-color: #66ffff;
            color: #66ffff;
        }
        
        .slider-group input[type="range"] {
            width: 60px;
            height: 80px;
            -webkit-appearance: slider-vertical;
            writing-mode: bt-lr;
        }
        
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #e8e8f0;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .slider-group input[type="range"]::-webkit-slider-runnable-track {
            width: 6px;
            background: #2a2a3a;
            border-radius: 3px;
        }
        
        .slider-value {
            font-size: 0.7rem;
            color: #e8e8f0;
            font-weight: 500;
        }
        
        .slider-section-label {
            font-size: 0.6rem;
            color: #555566;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            padding-right: 0.5rem;
            border-right: 1px solid #2a2a3a;
        }
        
        .mapping-section {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-shrink: 0;
        }
        
        .sliders-row {
            display: flex;
            gap: 1.5rem;
            flex-shrink: 0;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .overlay.header h1 {
                font-size: 1.5rem;
            }
            .overlay.header .subtitle {
                font-size: 0.9rem;
            }
            .overlay.legend {
                display: none;
            }
            .overlay.controls {
                flex-direction: column;
                right: 0.5rem;
                top: 0.5rem;
                gap: 0.3rem;
            }
            .overlay.controls button {
                font-size: 0.65rem;
                padding: 0.3rem 0.5rem;
            }
            .mapping-sliders {
                bottom: 4rem;
                padding: 0.5rem 0.75rem;
                gap: 0.75rem;
            }
            .slider-group {
                min-width: 50px;
            }
            .slider-group label {
                font-size: 0.6rem;
            }
            .slider-group input[type="range"] {
                height: 50px;
            }
            .slider-value {
                font-size: 0.6rem;
            }
            .slider-section-label {
                font-size: 0.5rem;
            }
            .timeline {
                padding: 0.3rem 0.5rem;
            }
            .instructions {
                font-size: 0.5rem;
            }
            .info-panel {
                width: 90vw;
                left: 5vw;
                right: 5vw;
            }
        }
        
        @media (max-width: 480px) {
            .overlay.header {
                top: 0.3rem;
                left: 0.3rem;
            }
            .overlay.header h1 {
                font-size: 1.2rem;
            }
            .mapping-sliders {
                bottom: 3rem;
                padding: 0.4rem 0.5rem;
            }
            .slider-group input[type="range"] {
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <div class="overlay header">
        <h1>collaboration space</h1>
        <p class="subtitle">f: Human √ó AI ‚Üí Artifact ¬∑ <a href="paper.html" style="color: #6699ff; text-decoration: none;">read the paper ‚Üí</a></p>
    </div>
    
    <a href="index.html" class="back-link">‚Üê back</a>
    
    <div class="overlay legend">
        <h3>f: H √ó A ‚Üí ùíú</h3>
        <div class="legend-item">
            <div class="legend-dot" style="background: #ff6699;"></div>
            <span>Human (H) ‚Äî the domain</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background: #6699ff;"></div>
            <span>AI (A) ‚Äî the co-domain</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background: #66ff99;"></div>
            <span>Artifact (ùíú) ‚Äî the codomain</span>
        </div>
        <div class="legend-item">
            <div class="legend-line" style="background: linear-gradient(90deg, #ff6699, #66ff99);"></div>
            <span>Fiber ‚Äî all paths to one artifact</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background: #ffcc66; box-shadow: 0 0 10px #ffcc66;"></div>
            <span>This ‚Äî you, here, now</span>
        </div>
        <p style="font-size: 0.65rem; color: #555; margin-top: 0.5rem; line-height: 1.4;">Click artifacts to see their fibers.<br>Thick fiber = many paths to same work.</p>
    </div>
    
    <div class="overlay controls">
        <button id="btn-rotate" class="active" title="Toggle auto-rotation (R)">auto-rotate</button>
        <button id="btn-fibers" title="Show/hide all fibers (F)">show all fibers</button>
        <button id="btn-sound" title="Play path sound (S)">‚ô™ sound the path</button>
        <button id="btn-reset" title="Reset camera view">reset view</button>
        <button id="btn-reset-sim" title="Randomize positions (Space)">reset sim</button>
        <button id="btn-share" title="Copy URL with current state">share state</button>
        <button id="btn-export" title="Download screenshot (E)">üì∑ export</button>
        <hr style="border: none; border-top: 1px solid #2a2a3a; margin: 0.5rem 0;">
        <button id="preset-harmony" title="All paths clear, all artifacts reachable (1)">harmony</button>
        <button id="preset-chaos" title="High entropy, thick fibers, many possibilities (2)">chaos</button>
        <button id="preset-dissolution" title="Memory fades, kernel grows, paths decay (3)">dissolution</button>
        <button id="btn-help" title="Understanding the space (?)">? help</button>
    </div>
    
    <div class="info-panel" id="info-panel">
        <button class="close" id="close-info">√ó</button>
        <h3 id="info-title">Artifact</h3>
        <p id="info-desc">Description</p>
        <div class="fiber-count" id="info-fiber"></div>
        <p id="info-fiber-desc"></p>
        <button class="play-sound" id="play-fiber-sound">‚ô™ play this fiber</button>
    </div>
    
    <div class="intro-modal" id="intro-modal">
        <div class="intro-content">
            <h2>f: Human √ó AI ‚Üí Artifact</h2>
            <p>You are looking at the space of all possible collaborations.</p>
            <ul>
                <li><span class="human-dot">‚óè</span> Human inputs rise from below</li>
                <li><span class="ai-dot">‚óè</span> AI inputs rise from the side</li>
                <li><span class="artifact-dot">‚óè</span> Artifacts emerge above ‚Äî irreducible</li>
                <li>Fibers connect inputs to outputs ‚Äî many paths, one destination</li>
            </ul>
            <p style="color: #888; font-size: 0.85rem; margin-top: 1rem;">The function is <em>surjective</em>: every artifact can be reached.<br>The function is <em>not injective</em>: multiple paths lead to the same place.</p>
            <p class="intro-hint">The glowing point is you, now, making this.</p>
            <button id="intro-dismiss">enter the space</button>
            <label class="intro-remember">
                <input type="checkbox" id="intro-dont-show"> don't show again
            </label>
        </div>
    </div>
    
    <div class="mapping-sliders" role="group" aria-label="Collaboration parameters">
        <div class="mapping-section">
            <span class="slider-section-label">Œ±</span>
            <div class="sliders-row">
                <div class="slider-group">
                    <label class="human" for="slider-human">Œ±(H)</label>
                    <input type="range" id="slider-human" min="0" max="100" value="100" orient="vertical" aria-label="Human opacity">
                    <span class="slider-value" id="val-human">1.0</span>
                </div>
                <div class="slider-group">
                    <label class="ai" for="slider-ai">Œ±(A)</label>
                    <input type="range" id="slider-ai" min="0" max="100" value="100" orient="vertical" aria-label="AI opacity">
                    <span class="slider-value" id="val-ai">1.0</span>
                </div>
                <div class="slider-group">
                    <label class="artifact" for="slider-artifact">Œ±(ùíú)</label>
                    <input type="range" id="slider-artifact" min="0" max="100" value="100" orient="vertical" aria-label="Artifact opacity">
                    <span class="slider-value" id="val-artifact">1.0</span>
                </div>
                <div class="slider-group">
                    <label class="fiber" for="slider-fiber">Œ±(Œì)</label>
                    <input type="range" id="slider-fiber" min="0" max="100" value="100" orient="vertical" aria-label="Fiber opacity">
                    <span class="slider-value" id="val-fiber">1.0</span>
                </div>
            </div>
        </div>
        <div class="mapping-section">
            <span class="slider-section-label">| |</span>
            <div class="sliders-row">
                <div class="slider-group">
                    <label class="human" for="count-human">|H|</label>
                    <input type="range" id="count-human" min="1" max="30" value="12" orient="vertical" aria-label="Human count">
                    <span class="slider-value" id="count-val-human">12</span>
                </div>
                <div class="slider-group">
                    <label class="ai" for="count-ai">|A|</label>
                    <input type="range" id="count-ai" min="1" max="30" value="12" orient="vertical" aria-label="AI count">
                    <span class="slider-value" id="count-val-ai">12</span>
                </div>
            </div>
        </div>
        <div class="mapping-section">
            <span class="slider-section-label">Œµ</span>
            <div class="sliders-row">
                <div class="slider-group">
                    <label class="entropy" for="slider-entropy">S</label>
                    <input type="range" id="slider-entropy" min="0" max="100" value="30" orient="vertical" aria-label="Entropy">
                    <span class="slider-value" id="val-entropy">0.3</span>
                </div>
                <div class="slider-group">
                    <label class="surjective" for="slider-surjective">‚àÄùíú‚àÉŒì</label>
                    <input type="range" id="slider-surjective" min="0" max="100" value="50" orient="vertical" aria-label="Surjectivity">
                    <span class="slider-value" id="val-surjective">0.5</span>
                </div>
            </div>
        </div>
        <div class="mapping-section">
            <span class="slider-section-label">t</span>
            <div class="sliders-row">
                <div class="slider-group">
                    <label class="decay" for="slider-decay">lim m‚Üí0</label>
                    <input type="range" id="slider-decay" min="0" max="100" value="0" orient="vertical" aria-label="Memory decay">
                    <span class="slider-value" id="val-decay">0.0</span>
                </div>
                <div class="slider-group">
                    <label class="derivative" for="slider-derivative">‚àÇf/‚àÇt</label>
                    <input type="range" id="slider-derivative" min="0" max="100" value="50" orient="vertical" aria-label="Rate of change">
                    <span class="slider-value" id="val-derivative">0.5</span>
                </div>
            </div>
        </div>
        <div class="mapping-section">
            <span class="slider-section-label">f</span>
            <div class="sliders-row">
                <div class="slider-group">
                    <label class="converge" for="slider-converge">Œ£1/2‚Åø</label>
                    <input type="range" id="slider-converge" min="0" max="100" value="0" orient="vertical" aria-label="Convergence">
                    <span class="slider-value" id="val-converge">0.0</span>
                </div>
                <div class="slider-group">
                    <label class="kernel" for="slider-kernel">|ker|</label>
                    <input type="range" id="slider-kernel" min="0" max="100" value="0" orient="vertical" aria-label="Kernel size">
                    <span class="slider-value" id="val-kernel">0</span>
                </div>
                <div class="slider-group">
                    <label class="injective">1:1</label>
                    <button id="btn-injective" class="toggle-btn" aria-label="Toggle injectivity">off</button>
                </div>
            </div>
        </div>
        <div class="mapping-section">
            <span class="slider-section-label">?</span>
            <div class="sliders-row">
                <div class="slider-group">
                    <label class="probability">P(?|œÜ)</label>
                    <button id="btn-probability" class="toggle-btn">show</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="timeline">
        <div class="timeline-label">
            <span>start</span>
            <span id="time-display">moment 0</span>
            <span>now</span>
        </div>
        <input type="range" id="timeline-slider" min="0" max="100" value="100">
        <div class="timeline-moment" id="timeline-moment"></div>
    </div>
    
    <p class="instructions">drag to rotate ¬∑ scroll to zoom ¬∑ click artifacts ¬∑ slide timeline ¬∑ adjust mapping</p>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        
        // ============ AUDIO CONTEXT ============
        let audioContext = null;
        
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }
        
        function playNote(frequency, duration, pan = 0, delay = 0) {
            const ctx = initAudio();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            const panner = ctx.createStereoPanner();
            
            // Entropy affects timbre - higher entropy = more dissonant
            const entropyEffect = typeof entropyValue !== 'undefined' ? entropyValue : 0.3;
            osc.type = entropyEffect > 0.6 ? 'sawtooth' : (entropyEffect > 0.3 ? 'triangle' : 'sine');
            
            // Add frequency wobble based on entropy
            const wobble = entropyEffect * 20 * (Math.random() - 0.5);
            osc.frequency.value = frequency + wobble;
            
            gain.gain.setValueAtTime(0, ctx.currentTime + delay);
            gain.gain.linearRampToValueAtTime(0.15, ctx.currentTime + delay + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + duration);
            
            panner.pan.value = pan;
            
            osc.connect(gain);
            gain.connect(panner);
            panner.connect(ctx.destination);
            
            osc.start(ctx.currentTime + delay);
            osc.stop(ctx.currentTime + delay + duration);
        }
        
        function positionToNote(pos) {
            // Map position to musical notes
            // X (human) -> base note (C3 to C5)
            // Y (artifact height) -> octave shift
            // Z (AI) -> chord character
            
            const baseFreq = 130.81; // C3
            const xNorm = (pos.x + 25) / 50; // 0-1
            const yNorm = (pos.y + 10) / 35; // 0-1
            const zNorm = (pos.z + 25) / 50; // 0-1
            
            // Pentatonic scale intervals
            const pentatonic = [0, 2, 4, 7, 9, 12, 14, 16, 19, 21];
            const noteIndex = Math.floor(xNorm * pentatonic.length);
            const semitones = pentatonic[noteIndex] + Math.floor(yNorm * 12);
            
            const freq = baseFreq * Math.pow(2, semitones / 12);
            const pan = (zNorm - 0.5) * 2; // -1 to 1
            
            return { freq, pan };
        }
        
        function playFiberSound(fiberPoints) {
            const duration = 0.4;
            fiberPoints.forEach((point, i) => {
                const { freq, pan } = positionToNote(point);
                playNote(freq, duration, pan, i * 0.15);
            });
        }
        
        // ============ TIMELINE MOMENTS ============
        const collaborationMoments = [
            { t: 0, text: "the function awaits its inputs..." },
            { t: 10, text: "\"what if notation could perform itself?\"" },
            { t: 20, text: "the formula becomes score: ‚à´ f(t) dt" },
            { t: 30, text: "seven pieces take shape in parallel" },
            { t: 40, text: "the thesis crystallizes: f: H √ó A ‚Üí ùíú" },
            { t: 50, text: "surjective‚Äîevery artifact reachable" },
            { t: 60, text: "not injective‚Äîmany paths, same destination" },
            { t: 70, text: "fibers, bundles, kernels..." },
            { t: 80, text: "\"what does the fiber over this artifact look like?\"" },
            { t: 90, text: "the paper writes its own collaboration" },
            { t: 100, text: "you are in the fiber now" },
        ];
        
        // ============ THREE.JS SETUP ============
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a0f);
        scene.fog = new THREE.FogExp2(0x0a0a0f, 0.012);
        
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(40, 30, 40);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        container.appendChild(renderer.domElement);
        
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;
        controls.target.set(0, 5, 0);
        
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        const colors = {
            human: 0xff6699,
            ai: 0x6699ff,
            artifact: 0x66ff99,
            current: 0xffcc66,
            fiber: 0x444466,
            fiberHighlight: 0xff99cc,
            grid: 0x1a1a2a
        };
        
        // Data structures
        const artifacts = [];
        const allFibers = [];
        const artifactFibers = new Map(); // Map artifact -> its fibers
        const humanPoints = [];
        const aiPoints = [];
        let currentPath = null;
        let currentPathPoints = [];
        let showAllFibers = false;
        let selectedArtifact = null;
        let timelineValue = 100;
        
        // ============ GRID ============
        function createGrid() {
            const gridHelper = new THREE.GridHelper(60, 30, colors.grid, colors.grid);
            gridHelper.position.y = -15;
            scene.add(gridHelper);
            
            const axisLength = 35;
            
            const xGeom = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(-axisLength, 0, 0),
                new THREE.Vector3(axisLength, 0, 0)
            ]);
            scene.add(new THREE.Line(xGeom, new THREE.LineBasicMaterial({ 
                color: colors.human, transparent: true, opacity: 0.4 
            })));
            
            const yGeom = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(0, -20, 0),
                new THREE.Vector3(0, 30, 0)
            ]);
            scene.add(new THREE.Line(yGeom, new THREE.LineBasicMaterial({ 
                color: colors.artifact, transparent: true, opacity: 0.4 
            })));
            
            const zGeom = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(0, 0, -axisLength),
                new THREE.Vector3(0, 0, axisLength)
            ]);
            scene.add(new THREE.Line(zGeom, new THREE.LineBasicMaterial({ 
                color: colors.ai, transparent: true, opacity: 0.4 
            })));
        }
        
        // ============ ARTIFACT ============
        function createArtifact(x, y, z, name, fiberThickness, description) {
            const geometry = new THREE.SphereGeometry(0.5, 16, 16);
            const material = new THREE.MeshBasicMaterial({ 
                color: colors.artifact,
                transparent: true,
                opacity: 0.9
            });
            const sphere = new THREE.Mesh(geometry, material);
            sphere.position.set(x, y, z);
            sphere.userData = { name, fiberThickness, description, type: 'artifact', originalColor: colors.artifact };
            scene.add(sphere);
            artifacts.push(sphere);
            artifactFibers.set(sphere, []);
            
            const glowGeom = new THREE.SphereGeometry(0.8, 16, 16);
            const glowMat = new THREE.MeshBasicMaterial({
                color: colors.artifact,
                transparent: true,
                opacity: 0.15
            });
            sphere.add(new THREE.Mesh(glowGeom, glowMat));
            
            return sphere;
        }
        
        // ============ FIBER ============
        function createFiber(startPos, artifactPos, artifact, isCurrentPath = false) {
            const midY = (startPos.y + artifactPos.y) / 2 + 5;
            const curve = new THREE.CatmullRomCurve3([
                new THREE.Vector3(startPos.x, startPos.y, startPos.z),
                new THREE.Vector3(
                    (startPos.x + artifactPos.x) / 2,
                    midY,
                    (startPos.z + artifactPos.z) / 2
                ),
                new THREE.Vector3(artifactPos.x, artifactPos.y, artifactPos.z)
            ]);
            
            const points = curve.getPoints(30);
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            
            const color = isCurrentPath ? colors.current : colors.fiber;
            const material = new THREE.LineBasicMaterial({ 
                color: color,
                transparent: true,
                opacity: isCurrentPath ? 0.9 : 0.08
            });
            
            const line = new THREE.Line(geometry, material);
            line.userData = { isCurrentPath, artifact, points };
            scene.add(line);
            allFibers.push(line);
            
            if (artifact && artifactFibers.has(artifact)) {
                artifactFibers.get(artifact).push(line);
            }
            
            return { line, points };
        }
        
        // ============ INPUT POINTS ============
        function createInputPoint(x, y, z, type) {
            const geometry = new THREE.SphereGeometry(0.3, 12, 12);
            const color = type === 'human' ? colors.human : colors.ai;
            const material = new THREE.MeshBasicMaterial({ 
                color: color,
                transparent: true,
                opacity: 0.7
            });
            const sphere = new THREE.Mesh(geometry, material);
            sphere.position.set(x, y, z);
            scene.add(sphere);
            
            if (type === 'human') humanPoints.push(sphere);
            else aiPoints.push(sphere);
            
            return sphere;
        }
        
        // ============ POPULATE ============
        function populateSpace() {
            const pieces = [
                { name: 'Memory', pos: [8, 10, 5], fiber: 2, desc: '‚à´‚ÇÄ^‚àû echo(t)¬∑fade(t) dt' },
                { name: 'Recursion', pos: [-10, 14, 8], fiber: 3, desc: 'f(n) = f(n-1) + f(n-2)' },
                { name: 'Convergence', pos: [12, 8, -8], fiber: 4, desc: 'lim_{n‚Üí‚àû} a‚Çô = L' },
                { name: 'Collaboration', pos: [0, 20, 0], fiber: 1, desc: 'f: H √ó A ‚Üí ùíú (sparse fiber)' },
                { name: 'Question', pos: [-8, 12, -10], fiber: 5, desc: '‚àÉx : P(x) ?' },
                { name: 'Inverse', pos: [15, 9, 10], fiber: 3, desc: 'f‚Åª¬π(y) = {x : f(x) = y}' },
                { name: 'Self-Reference', pos: [-5, 22, 6], fiber: 1, desc: 'This := perform(This)' },
            ];
            
            pieces.forEach(p => {
                const artifact = createArtifact(p.pos[0], p.pos[1], p.pos[2], p.name, p.fiber, p.desc);
                artifact.scale.set(1.3, 1.3, 1.3);
            });
            
            // Potential artifacts
            for (let i = 0; i < 25; i++) {
                const x = (Math.random() - 0.5) * 50;
                const y = Math.random() * 20 + 2;
                const z = (Math.random() - 0.5) * 50;
                const fiber = Math.floor(Math.random() * 8) + 2;
                const artifact = createArtifact(x, y, z, `Potential ${i+1}`, fiber, 'An artifact not yet realized');
                artifact.scale.set(0.6, 0.6, 0.6);
                artifact.material.opacity = 0.4;
            }
            
            // Input points
            for (let i = 0; i < 12; i++) {
                createInputPoint((Math.random() - 0.5) * 40, -10 + Math.random() * 3, (Math.random() - 0.5) * 15, 'human');
                createInputPoint((Math.random() - 0.5) * 15, -10 + Math.random() * 3, (Math.random() - 0.5) * 40, 'ai');
            }
            
            // Create fibers for main pieces
            artifacts.slice(0, 7).forEach((artifact) => {
                const numFibers = artifact.userData.fiberThickness || 2;
                for (let i = 0; i < numFibers; i++) {
                    const hIdx = Math.floor(Math.random() * humanPoints.length);
                    const aIdx = Math.floor(Math.random() * aiPoints.length);
                    const inputPos = {
                        x: (humanPoints[hIdx].position.x + aiPoints[aIdx].position.x) / 2,
                        y: -10,
                        z: (humanPoints[hIdx].position.z + aiPoints[aIdx].position.z) / 2
                    };
                    createFiber(inputPos, artifact.position, artifact, false);
                }
            });
            
            // Current collaboration
            const currentHuman = createInputPoint(-8, -8, 3, 'human');
            currentHuman.material.color.setHex(colors.current);
            currentHuman.material.opacity = 1;
            currentHuman.scale.set(1.8, 1.8, 1.8);
            
            const currentAI = createInputPoint(3, -8, -8, 'ai');
            currentAI.material.color.setHex(colors.current);
            currentAI.material.opacity = 1;
            currentAI.scale.set(1.8, 1.8, 1.8);
            
            const collabArtifact = artifacts.find(a => a.userData.name === 'Collaboration');
            if (collabArtifact) {
                collabArtifact.material.color.setHex(colors.current);
                collabArtifact.userData.originalColor = colors.current;
                collabArtifact.scale.set(2, 2, 2);
                
                const inputPos = {
                    x: (currentHuman.position.x + currentAI.position.x) / 2,
                    y: -8,
                    z: (currentHuman.position.z + currentAI.position.z) / 2
                };
                const { line, points } = createFiber(inputPos, collabArtifact.position, collabArtifact, true);
                currentPath = line;
                currentPathPoints = points;
            }
        }
        
        // ============ PARTICLES ============
        function createParticles() {
            const geometry = new THREE.BufferGeometry();
            const count = 400;
            const positions = new Float32Array(count * 3);
            
            for (let i = 0; i < count * 3; i += 3) {
                positions[i] = (Math.random() - 0.5) * 100;
                positions[i + 1] = (Math.random() - 0.5) * 60;
                positions[i + 2] = (Math.random() - 0.5) * 100;
            }
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            const material = new THREE.PointsMaterial({
                color: 0x445566,
                size: 0.15,
                transparent: true,
                opacity: 0.4
            });
            
            scene.add(new THREE.Points(geometry, material));
        }
        
        // ============ INVERSE GALLERY (#2) ============
        function highlightArtifactFibers(artifact) {
            // Reset all fibers first
            allFibers.forEach(f => {
                if (!f.userData.isCurrentPath) {
                    f.material.color.setHex(colors.fiber);
                    f.material.opacity = showAllFibers ? 0.25 : 0.08;
                }
            });
            
            // Reset all artifacts
            artifacts.forEach(a => {
                if (a !== artifact && a.userData.originalColor !== colors.current) {
                    a.material.color.setHex(a.userData.originalColor);
                }
            });
            
            if (!artifact) {
                selectedArtifact = null;
                return;
            }
            
            selectedArtifact = artifact;
            
            // Highlight this artifact's fibers
            const fibers = artifactFibers.get(artifact) || [];
            fibers.forEach(f => {
                f.material.color.setHex(colors.fiberHighlight);
                f.material.opacity = 0.8;
            });
        }
        
        // ============ CLICK HANDLING ============
        function onMouseClick(event) {
            if (event.target.closest('.overlay, .info-panel, .controls, .legend, button, a, .timeline')) {
                return;
            }
            
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(artifacts);
            
            if (intersects.length > 0) {
                const artifact = intersects[0].object;
                showInfoPanel(artifact.userData);
                highlightArtifactFibers(artifact);
                
                // Store for sound button
                window.selectedArtifactFibers = artifactFibers.get(artifact) || [];
            } else {
                hideInfoPanel();
                highlightArtifactFibers(null);
            }
        }
        
        function showInfoPanel(data) {
            document.getElementById('info-title').textContent = data.name;
            document.getElementById('info-desc').textContent = data.description;
            document.getElementById('info-fiber').textContent = `Fiber thickness: ${data.fiberThickness}`;
            
            const fiberDesc = data.fiberThickness === 1 
                ? 'Sparse fiber ‚Äî singular collaboration, unique path'
                : data.fiberThickness <= 3
                ? 'Thin fiber ‚Äî few paths reach this artifact'
                : 'Thick fiber ‚Äî many collaborations converge here';
            document.getElementById('info-fiber-desc').textContent = fiberDesc;
            
            document.getElementById('info-panel').classList.add('visible');
        }
        
        function hideInfoPanel() {
            document.getElementById('info-panel').classList.remove('visible');
        }
        
        // ============ TIMELINE (#1) ============
        function updateTimeline(value) {
            timelineValue = value;
            document.getElementById('time-display').textContent = `moment ${value}`;
            
            // Find appropriate moment text
            let momentText = '';
            for (let i = collaborationMoments.length - 1; i >= 0; i--) {
                if (value >= collaborationMoments[i].t) {
                    momentText = collaborationMoments[i].text;
                    break;
                }
            }
            document.getElementById('timeline-moment').textContent = momentText;
            
            // Animate the current path based on timeline
            if (currentPath && currentPathPoints.length > 0) {
                const visiblePoints = Math.floor((value / 100) * currentPathPoints.length);
                const newPoints = currentPathPoints.slice(0, Math.max(2, visiblePoints));
                const newGeom = new THREE.BufferGeometry().setFromPoints(newPoints);
                currentPath.geometry.dispose();
                currentPath.geometry = newGeom;
            }
            
            // Fade artifacts based on timeline
            const collabArtifact = artifacts.find(a => a.userData.name === 'Collaboration');
            if (collabArtifact) {
                collabArtifact.material.opacity = value / 100;
                const scale = 1 + (value / 100);
                collabArtifact.scale.set(scale, scale, scale);
            }
        }
        
        // ============ EVENT HANDLERS ============
        document.getElementById('close-info').addEventListener('click', () => {
            hideInfoPanel();
            highlightArtifactFibers(null);
        });
        
        document.getElementById('btn-rotate').addEventListener('click', function() {
            controls.autoRotate = !controls.autoRotate;
            this.classList.toggle('active');
        });
        
        document.getElementById('btn-fibers').addEventListener('click', function() {
            showAllFibers = !showAllFibers;
            this.classList.toggle('active');
            
            allFibers.forEach(f => {
                if (!f.userData.isCurrentPath) {
                    f.material.opacity = showAllFibers ? 0.25 : 0.08;
                }
            });
        });
        
        document.getElementById('btn-sound').addEventListener('click', function() {
            if (currentPathPoints.length > 0) {
                playFiberSound(currentPathPoints);
            }
        });
        
        document.getElementById('play-fiber-sound').addEventListener('click', function() {
            const fibers = window.selectedArtifactFibers || [];
            if (fibers.length > 0 && fibers[0].userData.points) {
                playFiberSound(fibers[0].userData.points);
            }
        });
        
        document.getElementById('btn-reset').addEventListener('click', function() {
            camera.position.set(40, 30, 40);
            controls.target.set(0, 5, 0);
            controls.autoRotate = true;
            document.getElementById('btn-rotate').classList.add('active');
            highlightArtifactFibers(null);
            hideInfoPanel();
            document.getElementById('timeline-slider').value = 100;
            updateTimeline(100);
        });
        
        document.getElementById('btn-reset-sim').addEventListener('click', function() {
            // Randomize all human point positions
            humanPoints.forEach(p => {
                p.position.set(
                    (Math.random() - 0.5) * 40,
                    -10 + Math.random() * 3,
                    (Math.random() - 0.5) * 15
                );
            });
            
            // Randomize all AI point positions
            aiPoints.forEach(p => {
                p.position.set(
                    (Math.random() - 0.5) * 15,
                    -10 + Math.random() * 3,
                    (Math.random() - 0.5) * 40
                );
            });
            
            // Randomize potential artifact positions
            artifacts.forEach(a => {
                if (a.userData.name && a.userData.name.startsWith('Potential')) {
                    a.position.set(
                        (Math.random() - 0.5) * 50,
                        Math.random() * 20 + 2,
                        (Math.random() - 0.5) * 50
                    );
                }
            });
        });
        
        document.getElementById('timeline-slider').addEventListener('input', function() {
            updateTimeline(parseInt(this.value));
        });
        
        // ============ MAPPING SLIDERS ============
        function updateMappingSlider(type, value) {
            const pct = value / 100;
            
            switch(type) {
                case 'human':
                    humanPoints.forEach(p => {
                        p.material.opacity = 0.7 * pct;
                        const s = 0.3 + pct * 0.7;
                        p.scale.set(s, s, s);
                    });
                    break;
                    
                case 'ai':
                    aiPoints.forEach(p => {
                        p.material.opacity = 0.7 * pct;
                        const s = 0.3 + pct * 0.7;
                        p.scale.set(s, s, s);
                    });
                    break;
                    
                case 'artifact':
                    artifacts.forEach(a => {
                        const baseOpacity = a.userData.name.startsWith('Potential') ? 0.4 : 0.9;
                        a.material.opacity = baseOpacity * pct;
                        // Don't scale the special ones too much
                        if (a.userData.originalColor !== colors.current) {
                            const baseScale = a.userData.name.startsWith('Potential') ? 0.6 : 1.3;
                            const s = baseScale * (0.3 + pct * 0.7);
                            a.scale.set(s, s, s);
                        }
                    });
                    break;
                    
                case 'fiber':
                    allFibers.forEach(f => {
                        if (f.userData.isCurrentPath) {
                            f.material.opacity = 0.9 * pct;
                        } else {
                            const baseOpacity = showAllFibers ? 0.25 : 0.08;
                            f.material.opacity = baseOpacity * pct;
                        }
                    });
                    break;
            }
        }
        
        ['human', 'ai', 'artifact', 'fiber'].forEach(type => {
            const slider = document.getElementById(`slider-${type}`);
            const display = document.getElementById(`val-${type}`);
            
            slider.addEventListener('input', function() {
                const val = parseInt(this.value);
                display.textContent = (val / 100).toFixed(1);
                updateMappingSlider(type, val);
            });
        });
        
        // ============ ENTROPY & SURJECTIVE SLIDERS ============
        let entropyValue = 0.3;
        let surjectiveValue = 0.5;
        
        document.getElementById('slider-entropy').addEventListener('input', function() {
            const val = parseInt(this.value);
            entropyValue = val / 100;
            document.getElementById('val-entropy').textContent = entropyValue.toFixed(1);
            
            // Entropy affects point movement chaos
            humanPoints.forEach(p => {
                p.userData.entropy = entropyValue;
            });
            aiPoints.forEach(p => {
                p.userData.entropy = entropyValue;
            });
        });
        
        document.getElementById('slider-surjective').addEventListener('input', function() {
            const val = parseInt(this.value);
            surjectiveValue = val / 100;
            document.getElementById('val-surjective').textContent = surjectiveValue.toFixed(1);
            
            // Surjective: higher = more fibers visible to potential artifacts
            artifacts.forEach(a => {
                if (a.userData.name && a.userData.name.startsWith('Potential')) {
                    a.material.opacity = 0.1 + surjectiveValue * 0.5;
                }
            });
        });
        
        // ============ COUNT SLIDERS ============
        function setPointCount(type, count) {
            const points = type === 'human' ? humanPoints : aiPoints;
            const color = type === 'human' ? colors.human : colors.ai;
            
            // Remove excess points
            while (points.length > count) {
                const p = points.pop();
                scene.remove(p);
            }
            
            // Add new points if needed
            while (points.length < count) {
                const geometry = new THREE.SphereGeometry(0.3, 12, 12);
                const material = new THREE.MeshBasicMaterial({ 
                    color: color,
                    transparent: true,
                    opacity: 0.7
                });
                const sphere = new THREE.Mesh(geometry, material);
                
                if (type === 'human') {
                    sphere.position.set(
                        (Math.random() - 0.5) * 40,
                        -10 + Math.random() * 3,
                        (Math.random() - 0.5) * 15
                    );
                } else {
                    sphere.position.set(
                        (Math.random() - 0.5) * 15,
                        -10 + Math.random() * 3,
                        (Math.random() - 0.5) * 40
                    );
                }
                
                scene.add(sphere);
                points.push(sphere);
            }
        }
        
        ['human', 'ai'].forEach(type => {
            const slider = document.getElementById(`count-${type}`);
            const display = document.getElementById(`count-val-${type}`);
            
            slider.addEventListener('input', function() {
                const val = parseInt(this.value);
                display.textContent = val;
                setPointCount(type, val);
            });
        });
        
        // Add entropy-based movement to animation loop
        function applyEntropyMovement() {
            humanPoints.forEach(p => {
                const e = p.userData.entropy || entropyValue;
                p.position.x += (Math.random() - 0.5) * e * 0.1;
                p.position.z += (Math.random() - 0.5) * e * 0.1;
            });
            aiPoints.forEach(p => {
                const e = p.userData.entropy || entropyValue;
                p.position.x += (Math.random() - 0.5) * e * 0.1;
                p.position.z += (Math.random() - 0.5) * e * 0.1;
            });
        }
        
        // ============ TIME-BASED CONTROLS ============
        let decayValue = 0;
        let derivativeValue = 0.5;
        let convergeValue = 0;
        let kernelValue = 0;
        let isInjective = false;
        let showProbabilityCloud = false;
        let probabilityCloud = null;
        let fiberAges = new Map(); // track when fibers were created
        let startTime = Date.now();
        
        // Initialize fiber ages
        function initFiberAges() {
            allFibers.forEach((f, i) => {
                fiberAges.set(f, startTime - (allFibers.length - i) * 1000);
            });
        }
        
        // Decay slider - older fibers fade
        document.getElementById('slider-decay').addEventListener('input', function() {
            const val = parseInt(this.value);
            decayValue = val / 100;
            document.getElementById('val-decay').textContent = decayValue.toFixed(1);
        });
        
        // Derivative slider - rate of change vs accumulated state
        document.getElementById('slider-derivative').addEventListener('input', function() {
            const val = parseInt(this.value);
            derivativeValue = val / 100;
            document.getElementById('val-derivative').textContent = derivativeValue.toFixed(1);
        });
        
        // Convergence slider - points drift toward artifacts  
        document.getElementById('slider-converge').addEventListener('input', function() {
            const val = parseInt(this.value);
            convergeValue = val / 100;
            document.getElementById('val-converge').textContent = convergeValue.toFixed(1);
        });
        
        // Kernel slider - failed collaborations (dim some points)
        document.getElementById('slider-kernel').addEventListener('input', function() {
            const val = parseInt(this.value);
            kernelValue = val;
            document.getElementById('val-kernel').textContent = val;
            
            // Mark some points as "in the kernel" (failed collaborations)
            const allPoints = [...humanPoints, ...aiPoints];
            allPoints.forEach((p, i) => {
                if (i < val) {
                    p.userData.inKernel = true;
                    p.material.opacity = 0.15;
                    p.material.color.setHex(0x444444);
                } else {
                    p.userData.inKernel = false;
                    const isHuman = humanPoints.includes(p);
                    p.material.opacity = 0.7;
                    p.material.color.setHex(isHuman ? colors.human : colors.ai);
                }
            });
        });
        
        // Injectivity toggle - one fiber per artifact
        document.getElementById('btn-injective').addEventListener('click', function() {
            isInjective = !isInjective;
            this.textContent = isInjective ? '1:1' : 'off';
            this.classList.toggle('active', isInjective);
            
            if (isInjective) {
                // Hide all but one fiber per artifact
                const seenArtifacts = new Set();
                allFibers.forEach(f => {
                    const art = f.userData.artifact;
                    if (art && seenArtifacts.has(art)) {
                        f.visible = false;
                    } else if (art) {
                        seenArtifacts.add(art);
                        f.visible = true;
                    }
                });
            } else {
                // Show all fibers again
                allFibers.forEach(f => f.visible = true);
            }
        });
        
        // Probability cloud toggle
        document.getElementById('btn-probability').addEventListener('click', function() {
            showProbabilityCloud = !showProbabilityCloud;
            this.textContent = showProbabilityCloud ? 'P(?)' : 'show';
            this.classList.toggle('active', showProbabilityCloud);
            
            if (showProbabilityCloud && !probabilityCloud) {
                // Create probability cloud around current collaboration
                const cloudGeometry = new THREE.SphereGeometry(5, 32, 32);
                const cloudMaterial = new THREE.MeshBasicMaterial({
                    color: 0xff66ff,
                    transparent: true,
                    opacity: 0.15,
                    wireframe: true
                });
                probabilityCloud = new THREE.Mesh(cloudGeometry, cloudMaterial);
                
                const collabArtifact = artifacts.find(a => a.userData.name === 'Collaboration');
                if (collabArtifact) {
                    probabilityCloud.position.copy(collabArtifact.position);
                }
                scene.add(probabilityCloud);
            }
            
            if (probabilityCloud) {
                probabilityCloud.visible = showProbabilityCloud;
            }
        });
        
        // Apply time-based effects in animation
        function applyTimeEffects() {
            const now = Date.now();
            
            // Decay effect - older fibers fade
            if (decayValue > 0) {
                allFibers.forEach(f => {
                    const age = fiberAges.get(f) || startTime;
                    const ageSeconds = (now - age) / 1000;
                    const decay = Math.exp(-decayValue * ageSeconds * 0.01);
                    const baseOpacity = f.userData.isCurrentPath ? 0.9 : 0.08;
                    f.material.opacity = baseOpacity * decay;
                });
            }
            
            // Derivative effect - recent changes glow brighter
            if (derivativeValue > 0.5) {
                const intensity = (derivativeValue - 0.5) * 2;
                allFibers.forEach(f => {
                    const age = fiberAges.get(f) || startTime;
                    const ageSeconds = (now - age) / 1000;
                    if (ageSeconds < 5) {
                        f.material.opacity = Math.min(1, f.material.opacity + intensity * 0.3);
                    }
                });
            }
            
            // Convergence effect - points drift toward nearest artifact
            if (convergeValue > 0) {
                [...humanPoints, ...aiPoints].forEach(p => {
                    if (p.userData.inKernel) return;
                    
                    let nearestArt = null;
                    let nearestDist = Infinity;
                    artifacts.forEach(a => {
                        const d = p.position.distanceTo(a.position);
                        if (d < nearestDist) {
                            nearestDist = d;
                            nearestArt = a;
                        }
                    });
                    
                    if (nearestArt && nearestDist > 3) {
                        const dir = nearestArt.position.clone().sub(p.position).normalize();
                        p.position.add(dir.multiplyScalar(convergeValue * 0.02));
                    }
                });
            }
            
            // Probability cloud pulsing
            if (probabilityCloud && probabilityCloud.visible) {
                const t = now * 0.001;
                const scale = 1 + Math.sin(t * 1.5) * 0.3 + Math.random() * 0.1;
                probabilityCloud.scale.set(scale, scale, scale);
                probabilityCloud.rotation.x += 0.002;
                probabilityCloud.rotation.y += 0.003;
                probabilityCloud.material.opacity = 0.1 + Math.random() * 0.1;
            }
        }
        
        // ============ ANIMATION ============
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            
            // Apply entropy-based movement
            applyEntropyMovement();
            
            // Apply time-based effects
            applyTimeEffects();
            
            const time = Date.now() * 0.001;
            const collabArtifact = artifacts.find(a => a.userData.name === 'Collaboration');
            if (collabArtifact && timelineValue === 100) {
                const baseScale = 2;
                const scale = baseScale + Math.sin(time * 2) * 0.15;
                collabArtifact.scale.set(scale, scale, scale);
            }
            
            if (currentPath && timelineValue === 100) {
                currentPath.material.opacity = 0.7 + Math.sin(time * 3) * 0.25;
            }
            
            renderer.render(scene, camera);
        }
        
        // ============ RESIZE ============
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        window.addEventListener('click', onMouseClick);
        
        // ============ URL STATE ============
        function getStateFromURL() {
            const params = new URLSearchParams(window.location.search);
            const state = {};
            for (const [key, value] of params) {
                state[key] = parseFloat(value);
            }
            return state;
        }
        
        function updateURL() {
            const state = {
                h: document.getElementById('slider-human').value,
                a: document.getElementById('slider-ai').value,
                art: document.getElementById('slider-artifact').value,
                fib: document.getElementById('slider-fiber').value,
                ch: document.getElementById('count-human').value,
                ca: document.getElementById('count-ai').value,
                s: document.getElementById('slider-entropy').value,
                sur: document.getElementById('slider-surjective').value,
                dec: document.getElementById('slider-decay').value,
                der: document.getElementById('slider-derivative').value,
                con: document.getElementById('slider-converge').value,
                ker: document.getElementById('slider-kernel').value,
                inj: isInjective ? 1 : 0,
                prob: showProbabilityCloud ? 1 : 0
            };
            const params = new URLSearchParams(state);
            history.replaceState(null, '', '?' + params.toString());
        }
        
        function applyURLState() {
            const state = getStateFromURL();
            if (Object.keys(state).length === 0) return;
            
            const sliderMap = {
                h: 'slider-human', a: 'slider-ai', art: 'slider-artifact', fib: 'slider-fiber',
                ch: 'count-human', ca: 'count-ai', s: 'slider-entropy', sur: 'slider-surjective',
                dec: 'slider-decay', der: 'slider-derivative', con: 'slider-converge', ker: 'slider-kernel'
            };
            
            for (const [key, sliderId] of Object.entries(sliderMap)) {
                if (state[key] !== undefined) {
                    const slider = document.getElementById(sliderId);
                    if (slider) {
                        slider.value = state[key];
                        slider.dispatchEvent(new Event('input'));
                    }
                }
            }
            
            if (state.inj === 1) {
                document.getElementById('btn-injective').click();
            }
            if (state.prob === 1) {
                document.getElementById('btn-probability').click();
            }
        }
        
        // Add share button functionality
        document.getElementById('btn-share')?.addEventListener('click', function() {
            updateURL();
            navigator.clipboard.writeText(window.location.href).then(() => {
                this.textContent = 'copied!';
                setTimeout(() => this.textContent = 'share state', 2000);
            });
        });
        
        // Add export/screenshot functionality
        document.getElementById('btn-export')?.addEventListener('click', function() {
            renderer.render(scene, camera);
            const dataURL = renderer.domElement.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = 'collaboration_space_' + Date.now() + '.png';
            link.href = dataURL;
            link.click();
            this.textContent = 'saved!';
            setTimeout(() => this.textContent = 'üì∑ export', 2000);
        });
        
        // Update URL on slider changes (debounced)
        let urlUpdateTimeout;
        document.querySelectorAll('.mapping-sliders input[type="range"]').forEach(slider => {
            slider.addEventListener('input', () => {
                clearTimeout(urlUpdateTimeout);
                urlUpdateTimeout = setTimeout(updateURL, 500);
            });
        });
        
        // ============ PRESETS ============
        function applyPreset(preset) {
            const presets = {
                harmony: {
                    h: 100, a: 100, art: 100, fib: 100,
                    ch: 12, ca: 12,
                    s: 20, sur: 80,
                    dec: 0, der: 30,
                    con: 30, ker: 0, inj: false, prob: false
                },
                chaos: {
                    h: 100, a: 100, art: 80, fib: 60,
                    ch: 25, ca: 25,
                    s: 90, sur: 30,
                    dec: 40, der: 90,
                    con: 0, ker: 30, inj: false, prob: true
                },
                dissolution: {
                    h: 40, a: 40, art: 60, fib: 30,
                    ch: 8, ca: 8,
                    s: 50, sur: 20,
                    dec: 80, der: 10,
                    con: 80, ker: 60, inj: false, prob: false
                }
            };
            
            const p = presets[preset];
            if (!p) return;
            
            const sliderMap = {
                h: 'slider-human', a: 'slider-ai', art: 'slider-artifact', fib: 'slider-fiber',
                ch: 'count-human', ca: 'count-ai', s: 'slider-entropy', sur: 'slider-surjective',
                dec: 'slider-decay', der: 'slider-derivative', con: 'slider-converge', ker: 'slider-kernel'
            };
            
            for (const [key, sliderId] of Object.entries(sliderMap)) {
                if (p[key] !== undefined) {
                    const slider = document.getElementById(sliderId);
                    if (slider) {
                        slider.value = p[key];
                        slider.dispatchEvent(new Event('input'));
                    }
                }
            }
            
            // Handle toggles
            if (p.inj !== isInjective) document.getElementById('btn-injective').click();
            if (p.prob !== showProbabilityCloud) document.getElementById('btn-probability').click();
            
            updateURL();
        }
        
        document.getElementById('preset-harmony')?.addEventListener('click', () => applyPreset('harmony'));
        document.getElementById('preset-chaos')?.addEventListener('click', () => applyPreset('chaos'));
        document.getElementById('preset-dissolution')?.addEventListener('click', () => applyPreset('dissolution'));
        
        // ============ HELP MODAL ============
        const helpHTML = `
            <div id="help-modal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(10,10,15,0.95);z-index:1001;display:flex;align-items:center;justify-content:center;overflow-y:auto;">
                <div style="max-width:500px;padding:2rem;text-align:left;color:#e8e8f0;">
                    <h2 style="font-family:'Times New Roman',serif;font-style:italic;margin-bottom:1rem;">Understanding the Space</h2>
                    
                    <div style="font-size:0.8rem;color:#888;line-height:1.6;margin-bottom:1.5rem;">
                        <p style="margin-bottom:0.5rem;"><strong style="color:#66ff99;">Surjective:</strong> Every artifact can be reached. No creative outcome is blocked.</p>
                        <p style="margin-bottom:0.5rem;"><strong style="color:#ff6699;">Not injective:</strong> Multiple paths lead to the same artifact. Authorship dissolves.</p>
                        <p><strong style="color:#ffcc66;">The fiber:</strong> All (human, AI) pairs that produce a given artifact. Click any to see.</p>
                    </div>
                    
                    <h3 style="font-size:0.9rem;color:#6699ff;margin-bottom:0.5rem;">Presets</h3>
                    <div style="font-size:0.75rem;color:#666;line-height:1.6;margin-bottom:1rem;">
                        <div><strong style="color:#aaa;">Harmony</strong> ‚Äî High surjectivity. All paths clear. Every artifact reachable.</div>
                        <div><strong style="color:#aaa;">Chaos</strong> ‚Äî High entropy. Many inputs, thick fibers, probability clouds.</div>
                        <div><strong style="color:#aaa;">Dissolution</strong> ‚Äî Memory fades. Kernel grows. Collaborations fail silently.</div>
                    </div>
                    
                    <h3 style="font-size:0.9rem;color:#6699ff;margin-bottom:0.5rem;">Controls</h3>
                    <div style="font-size:0.8rem;color:#aaa;line-height:1.8;">
                        <div><kbd style="background:#2a2a3a;padding:2px 6px;border-radius:3px;">Space</kbd> Randomize ‚Äî new collaboration possibilities</div>
                        <div><kbd style="background:#2a2a3a;padding:2px 6px;border-radius:3px;">R</kbd> Rotate ‚Äî orbit the space</div>
                        <div><kbd style="background:#2a2a3a;padding:2px 6px;border-radius:3px;">F</kbd> Fibers ‚Äî show all paths</div>
                        <div><kbd style="background:#2a2a3a;padding:2px 6px;border-radius:3px;">S</kbd> Sound ‚Äî play this path as music</div>
                        <div><kbd style="background:#2a2a3a;padding:2px 6px;border-radius:3px;">E</kbd> Export ‚Äî save as image</div>
                        <div><kbd style="background:#2a2a3a;padding:2px 6px;border-radius:3px;">1 2 3</kbd> Presets</div>
                        <div><kbd style="background:#2a2a3a;padding:2px 6px;border-radius:3px;">Esc</kbd> Close</div>
                    </div>
                    <button id="help-close" style="margin-top:1.5rem;padding:0.5rem 1.5rem;background:transparent;border:1px solid #66ff99;color:#66ff99;cursor:pointer;border-radius:4px;">close</button>
                </div>
            </div>
        `;
        
        function showHelp() {
            if (document.getElementById('help-modal')) return;
            document.body.insertAdjacentHTML('beforeend', helpHTML);
            document.getElementById('help-close').addEventListener('click', hideHelp);
        }
        
        function hideHelp() {
            document.getElementById('help-modal')?.remove();
        }
        
        document.getElementById('btn-help')?.addEventListener('click', showHelp);
        
        // ============ KEYBOARD SHORTCUTS ============
        document.addEventListener('keydown', (e) => {
            // Ignore if typing in input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key.toLowerCase()) {
                case ' ':
                    e.preventDefault();
                    document.getElementById('btn-reset-sim').click();
                    break;
                case 'r':
                    document.getElementById('btn-rotate').click();
                    break;
                case 'f':
                    document.getElementById('btn-fibers').click();
                    break;
                case 's':
                    document.getElementById('btn-sound').click();
                    break;
                case 'e':
                    document.getElementById('btn-export').click();
                    break;
                case '1':
                    applyPreset('harmony');
                    break;
                case '2':
                    applyPreset('chaos');
                    break;
                case '3':
                    applyPreset('dissolution');
                    break;
                case '?':
                    showHelp();
                    break;
                case 'escape':
                    hideHelp();
                    introModal.classList.add('hidden');
                    break;
            }
        });
        
        // ============ REDUCED MOTION ============
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (prefersReducedMotion) {
            // Disable auto-rotate by default, slow down animations
            controls.autoRotate = false;
            document.getElementById('btn-rotate').classList.remove('active');
            document.getElementById('btn-rotate').textContent = 'auto-rotate';
        }
        
        // ============ INIT ============
        createGrid();
        createParticles();
        populateSpace();
        initFiberAges();
        applyURLState();
        animate();
        updateTimeline(100);
        
        // ============ INTRO MODAL ============
        const introModal = document.getElementById('intro-modal');
        const introDismiss = document.getElementById('intro-dismiss');
        const introDontShow = document.getElementById('intro-dont-show');
        
        // Check if user has seen intro before
        if (localStorage.getItem('collab-space-intro-seen')) {
            introModal.classList.add('hidden');
        }
        
        introDismiss?.addEventListener('click', () => {
            introModal.classList.add('hidden');
            if (introDontShow?.checked) {
                localStorage.setItem('collab-space-intro-seen', 'true');
            }
        });
        
        console.log('Collaboration Space v7 loaded ‚Äî presets, keyboard shortcuts, accessibility');
     </script>
</body>
</html>
